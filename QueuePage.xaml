<Page x:Class="SubsonicUWP.QueuePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:SubsonicUWP"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" mc:Ignorable="d">

    <Page.Resources>
        <MenuFlyout x:Key="QueueItemMenu">
            <MenuFlyoutItem Text="Play now" Click="PlayNow_Click"/>
            <MenuFlyoutItem Text="Play next" Click="PlayNext_Click"/>
            <MenuFlyoutItem Text="Remove from queue" Click="Remove_Click"/>
            <MenuFlyoutItem Text="Add to playlist" Click="AddToPlaylist_Click"/>
            <MenuFlyoutItem Text="Favorite" Click="Favorite_Click"/>
            <MenuFlyoutItem Text="Download" Click="Download_Click"/>
        </MenuFlyout>
    </Page.Resources>

    <Grid>
        <ListView x:Name="QueueList" Background="Transparent" BorderThickness="0" ItemsSource="{Binding PlaybackQueue}" SelectedIndex="{Binding CurrentQueueIndex, Mode=TwoWay}" CanReorderItems="True" AllowDrop="True" CanDragItems="True" IsItemClickEnabled="True" ItemClick="QueueList_ItemClick">
            <ListView.Header>
                <Border Padding="24">
                    <StackPanel>
                        <TextBlock Text="Now Playing" FontSize="14" Opacity="0.6" FontWeight="SemiBold"/>
                        <Grid Margin="0,4,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="NameBox" Text="{Binding QueueName, Mode=TwoWay}" FontSize="32" FontWeight="Light" FontFamily="Segoe UI Light" Background="Transparent" BorderThickness="0" Padding="0" KeyDown="NameBox_KeyDown" LostFocus="NameBox_LostFocus" PlaceholderText="Queue Name"/>
                            <Button x:Name="RenameButton" Grid.Column="1" Click="RenameButton_Click" Background="Transparent" BorderThickness="0" Padding="12,4" VerticalAlignment="Center" Margin="8,0,0,0" ToolTipService.ToolTip="Rename">
                                <TextBlock Text="&#xE70F;" FontFamily="Segoe MDL2 Assets" FontSize="20" Opacity="0.5"/>
                            </Button>
                        </Grid>

                        <!-- Actions Below Name -->
                        <StackPanel Orientation="Horizontal" Margin="-8,0,0,0">
                            <Button Margin="8,0,8,0" Content="Clear" Opacity="0.7" Click="Clear_Click"/>
                            <Button Margin="8,0,8,0" Content="Save as Playlist" Opacity="0.7" Click="SaveSession_Click"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </ListView.Header>
            <ListView.ItemContainerTransitions>
                <TransitionCollection>
                    <ReorderThemeTransition/>
                    <RepositionThemeTransition/>
                    <AddDeleteThemeTransition/>
                </TransitionCollection>
            </ListView.ItemContainerTransitions>
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    <Setter Property="Padding" Value="0"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListViewItem">
                                <ListViewItemPresenter ContentTransitions="{TemplateBinding ContentTransitions}" SelectionCheckMarkVisualEnabled="False" SelectedBackground="{ThemeResource SystemControlHighlightAccentBrush}" SelectedForeground="White" SelectedPointerOverBackground="{ThemeResource SystemControlHighlightListAccentMediumBrush}" SelectedPressedBackground="{ThemeResource SystemControlHighlightListAccentHighBrush}" PressedBackground="{ThemeResource SystemControlHighlightListMediumBrush}" PointerOverBackground="{ThemeResource SystemControlHighlightListLowBrush}" FocusVisualPrimaryBrush="Transparent" FocusVisualSecondaryBrush="Transparent"/>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListView.ItemContainerStyle>
            <ListView.ItemTemplate>
                <DataTemplate>
                    <Grid Margin="0,4,16,4">
                        <!-- Swipe Background -->
                        <!-- Swipe Background -->
                        <Grid x:Name="BackdropGrid" CornerRadius="4">
                            <Grid x:Name="RemoveBackdrop" Background="Red" HorizontalAlignment="Stretch" Visibility="Collapsed">
                                <TextBlock Text="&#xE74D;" FontFamily="Segoe MDL2 Assets" FontSize="20" Foreground="White" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="16,0,0,0"/>
                            </Grid>
                            <Grid x:Name="PlayNextBackdrop" Background="Green" HorizontalAlignment="Stretch" Visibility="Collapsed">
                                <TextBlock Text="&#xE70E;" FontFamily="Segoe MDL2 Assets" FontSize="20" Foreground="White" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,16,0"/>
                            </Grid>
                        </Grid>

                        <!-- Foreground Content -->
                        <Grid x:Name="ContentGrid" Background="{Binding IsPlaying, Converter={StaticResource BoolToBrushConverter}}" Margin="0" Padding="12,8" FlyoutBase.AttachedFlyout="{StaticResource QueueItemMenu}" ManipulationMode="TranslateX,System" ManipulationDelta="Item_ManipulationDelta" ManipulationCompleted="Item_ManipulationCompleted">
                            <Grid.RenderTransform>
                                <CompositeTransform x:Name="ContentTransform"/>
                            </Grid.RenderTransform>

                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="32"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                <TextBlock Text="{Binding Title}" FontSize="15" FontWeight="SemiBold" Foreground="{Binding IsPlaying, Converter={StaticResource BoolToForegroundConverter}}"/>
                                <TextBlock Text="{Binding Artist}" FontSize="13" Opacity="0.7" Foreground="{Binding IsPlaying, Converter={StaticResource BoolToForegroundConverter}}"/>
                            </StackPanel>

                            <!-- Remove Button (Clickable fallback) -->
                            <Button Grid.Column="1" Background="Transparent" BorderThickness="0" Padding="8" Click="Remove_Click" ToolTipService.ToolTip="Remove" VerticalAlignment="Center" Margin="0,0,4,0">
                                <TextBlock Text="&#xE74D;" FontFamily="Segoe MDL2 Assets" FontSize="16" Opacity="0.6" Foreground="{Binding IsPlaying, Converter={StaticResource BoolToForegroundConverter}}"/>
                            </Button>

                            <!-- Drag Handle -->
                            <TextBlock Grid.Column="2" Text="&#xE700;" FontFamily="Segoe MDL2 Assets" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.3" FontSize="16" Foreground="{Binding IsPlaying, Converter={StaticResource BoolToForegroundConverter}}"/>
                        </Grid>
                    </Grid>
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>
    </Grid>
</Page>
