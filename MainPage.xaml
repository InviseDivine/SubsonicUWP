<Page x:Class="SubsonicUWP.MainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:SubsonicUWP.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" mc:Ignorable="d" Background="{ThemeResource WindowBackgroundBrush}">

    <Grid>

        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="WindowStates">
                <VisualState x:Name="WideState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="850"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="RootSplitView.DisplayMode" Value="Inline"/>
                        <Setter Target="RootSplitView.IsPaneOpen" Value="True"/>
                        <Setter Target="MobileHeader.Visibility" Value="Collapsed"/>
                    </VisualState.Setters>
                </VisualState>
                <VisualState x:Name="NarrowState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="RootSplitView.DisplayMode" Value="Overlay"/>
                        <Setter Target="RootSplitView.IsPaneOpen" Value="False"/>
                        <Setter Target="MobileHeader.Visibility" Value="Visible"/>

                        <!-- Mobile Player Bar Adjustments -->
                        <Setter Target="SearchBox.Visibility" Value="Collapsed"/>
                        <Setter Target="FavoriteButton.Visibility" Value="Collapsed"/>
                        <Setter Target="ShuffleButton.Visibility" Value="Collapsed"/>
                        <Setter Target="RepeatButton.Visibility" Value="Collapsed"/>

                        <Setter Target="MoreButton.Visibility" Value="Collapsed"/>
                        <Setter Target="VolumePanel.Visibility" Value="Collapsed"/>
                        <Setter Target="PlayerBarCol0.Width" Value="*"/>
                        <Setter Target="PlayerBarCol1.Width" Value="Auto"/>
                        <Setter Target="PlayerBarCol2.Width" Value="0"/>

                        <!-- Mobile Compact Player Sizes -->
                        <Setter Target="PlayerBarGrid.Height" Value="56"/>
                        <Setter Target="PlayerControlsPanel.Margin" Value="0,0,12,0"/>
                        <Setter Target="PlayerControlsPanel.HorizontalAlignment" Value="Right"/>

                        <Setter Target="PlayPauseButton.Width" Value="48"/>
                        <Setter Target="PlayPauseButton.Height" Value="48"/>
                        <Setter Target="PlayPauseButton.Margin" Value="0,0"/>

                        <Setter Target="PrevButton.Width" Value="48"/>
                        <Setter Target="PrevButton.Height" Value="48"/>
                        <Setter Target="PrevButton.Margin" Value="0,0"/>

                        <Setter Target="NextButton.Width" Value="48"/>
                        <Setter Target="NextButton.Height" Value="48"/>
                        <Setter Target="NextButton.Margin" Value="0,0"/>

                        <Setter Target="ShuffleButton.Width" Value="48"/>
                        <Setter Target="ShuffleButton.Height" Value="48"/>
                        <Setter Target="ShuffleButton.Margin" Value="0,0"/>

                        <!-- Target the Grid instead of Image for resizing -->
                        <Setter Target="AlbumArtGrid.Width" Value="40"/>
                        <Setter Target="AlbumArtGrid.Height" Value="40"/>
                        <Setter Target="BufferingRing.Width" Value="30"/>
                        <Setter Target="BufferingRing.Height" Value="30"/>

                        <Setter Target="FavoriteButton.Margin" Value="4,0"/>


                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <!-- Player Bar -->
        </Grid.RowDefinitions>

        <SplitView x:Name="RootSplitView" Grid.Row="0" OpenPaneLength="260" DisplayMode="Inline" IsPaneOpen="True">
            <SplitView.Pane>
                <!-- Nav Rail -->
                <Border Background="{ThemeResource NavRailBackgroundBrush}">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                        <StackPanel Margin="0">
                            <!-- App Title -->
                            <TextBlock Text="Subsonic UWP" FontSize="16" FontWeight="SemiBold" FontStretch="Condensed" Margin="16,18,0,24" Foreground="{ThemeResource ForegroundBrush}"/>

                            <!-- Search Box -->
                            <AutoSuggestBox x:Name="SearchBox" QueryIcon="Find" PlaceholderText="Search" Margin="16,0,16,16" QuerySubmitted="SearchBox_QuerySubmitted" Foreground="{ThemeResource ForegroundBrush}"/>

                            <!-- Nav Items -->

                            <ListView x:Name="NavList" ItemsSource="{Binding NavItems}" Background="Transparent" BorderThickness="0" ItemClick="NavList_ItemClick" IsItemClickEnabled="True" Padding="0" SelectionMode="Single">
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="ListViewItem">
                                        <Setter Property="Padding" Value="16,10"/>
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="Foreground" Value="{ThemeResource SecondaryForegroundBrush}"/>
                                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                    </Style>
                                </ListView.ItemContainerStyle>
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding Symbol}" FontFamily="Segoe MDL2 Assets" FontSize="16" Width="40" VerticalAlignment="Center"/>
                                            <TextBlock Text="{Binding Label}" FontSize="15" VerticalAlignment="Center" FontFamily="Segoe UI"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </SplitView.Pane>

            <SplitView.Content>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Mobile Header (Visible only in Narrow State) -->
                    <Grid x:Name="MobileHeader" Height="48" Background="{ThemeResource NavRailBackgroundBrush}" Visibility="Collapsed">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <Button x:Name="HamburgerButton" Background="Transparent" BorderThickness="0" Width="48" Height="48" Click="HamburgerButton_Click">
                                <TextBlock Text="&#xE700;" FontFamily="Segoe MDL2 Assets" FontSize="20" Foreground="{ThemeResource ForegroundBrush}"/>
                            </Button>
                            <TextBlock Text="Subsonic" FontSize="16" FontWeight="SemiBold" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="{ThemeResource ForegroundBrush}"/>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,8,0">
                            <Button x:Name="MobileSearchButton" Background="Transparent" BorderThickness="0" Width="48" Height="48" Click="MobileSearchButton_Click">
                                <SymbolIcon Symbol="Find" Foreground="{ThemeResource ForegroundBrush}"/>
                            </Button>
                            <Button x:Name="MobileRestoreButton" Background="Transparent" BorderThickness="0" Width="48" Height="48" Click="MobileRestoreButton_Click">
                                <TextBlock Text="&#xE81C;" FontFamily="Segoe MDL2 Assets" FontSize="20" Foreground="{ThemeResource ForegroundBrush}"/>
                            </Button>
                        </StackPanel>
                    </Grid>

                    <!-- Content Frame -->
                    <Frame x:Name="ContentFrame" Grid.Row="1">
                        <Frame.ContentTransitions>
                            <TransitionCollection>
                                <NavigationThemeTransition/>
                            </TransitionCollection>
                        </Frame.ContentTransitions>
                    </Frame>
                </Grid>
            </SplitView.Content>
        </SplitView>

        <!-- Player Bar -->
        <Grid x:Name="PlayerBarGrid" Grid.Row="1" Grid.ColumnSpan="2" Height="90" Background="{ThemeResource PlayerBarBackgroundBrush}" ManipulationMode="TranslateY" ManipulationCompleted="PlayerBar_ManipulationCompleted">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="PlayerBarCol0" Width="*"/>
                <ColumnDefinition x:Name="PlayerBarCol1" Width="Auto"/>
                <ColumnDefinition x:Name="PlayerBarCol2" Width="*"/>
            </Grid.ColumnDefinitions>

            <Border BorderBrush="{ThemeResource ControlBackgroundBrush}" BorderThickness="0,1,0,0" Grid.ColumnSpan="3" VerticalAlignment="Top"/>

            <!-- Album Art & Info -->
            <Grid Margin="12,0,6,0" Tapped="PlayerBar_Tapped" Background="Transparent">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Grid x:Name="AlbumArtGrid" Grid.Column="0" Margin="0,8" Width="64" Height="64">
                    <Image Grid.RowSpan="2" Source="{x:Bind LocalAlbumArt, Mode=OneWay}" Stretch="UniformToFill" VerticalAlignment="Stretch" HorizontalAlignment="Stretch"/>
                    <ProgressRing x:Name="BufferingRing" IsActive="{Binding IsBuffering}" Width="40" Height="40" Foreground="{ThemeResource AccentBrush}" VerticalAlignment="Center" HorizontalAlignment="Center" IsHitTestVisible="False"/>
                </Grid>
                <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="12,0">
                    <controls:ScrollableTextBlock Text="{Binding CurrentSong.Title, FallbackValue='Not Playing'}" FontWeight="SemiBold" FontSize="15" Foreground="{ThemeResource ForegroundBrush}"/>
                    <controls:ScrollableTextBlock Text="{Binding CurrentSong.Artist, FallbackValue=''}" FontSize="13" Margin="0,2,0,0" Foreground="{ThemeResource SecondaryForegroundBrush}" Opacity="0.7" IsTapEnabled="True" Tapped="PlayerArtist_Tapped"/>
                </StackPanel>
            </Grid>

            <!-- Controls -->
            <!-- Controls -->
            <!-- Controls -->
            <!-- Controls -->
            <StackPanel x:Name="PlayerControlsPanel" Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                <Button x:Name="FavoriteButton" ToolTipService.ToolTip="Favorite" Width="48" Height="48" Margin="8" Background="Transparent" Click="FavoriteButton_Click">
                    <SymbolIcon x:Name="FavoriteIcon" Symbol="OutlineStar" Foreground="{ThemeResource SecondaryForegroundBrush}"/>
                </Button>
                <Button x:Name="ShuffleButton" ToolTipService.ToolTip="Shuffle" Width="48" Height="48" Margin="8" Background="Transparent" Click="Control_Click">
                    <Grid>
                        <SymbolIcon x:Name="ShuffleIcon" Symbol="Shuffle" Foreground="{ThemeResource SecondaryForegroundBrush}"/>
                        <Line x:Name="ShuffleStrike" X1="0" Y1="18" X2="18" Y2="0" Stroke="{ThemeResource SecondaryForegroundBrush}" StrokeThickness="2" Visibility="Collapsed" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                    </Grid>
                </Button>
                <Button x:Name="PrevButton" ToolTipService.ToolTip="Prev" Width="48" Height="48" Margin="8" Background="Transparent" Click="Prev_Click">
                    <SymbolIcon Symbol="Previous" Foreground="{ThemeResource ForegroundBrush}"/>
                </Button>
                <Button x:Name="PlayPauseButton" ToolTipService.ToolTip="Play" Width="48" Height="48" Background="{ThemeResource ControlBackgroundBrush}" Margin="8" Click="Play_Click">
                    <Button.Content>
                        <SymbolIcon x:Name="PlayPauseIcon" Symbol="Play" Foreground="{ThemeResource ForegroundBrush}" Margin="2,0,0,0"/>
                    </Button.Content>
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Grid>
                                <Ellipse Fill="{TemplateBinding Background}"/>
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Grid>
                        </ControlTemplate>
                    </Button.Template>
                </Button>
                <Button x:Name="NextButton" ToolTipService.ToolTip="Next" Width="48" Height="48" Margin="8" Background="Transparent" Click="Next_Click">
                    <SymbolIcon Symbol="Next" Foreground="{ThemeResource ForegroundBrush}"/>
                </Button>
                <Button x:Name="RepeatButton" ToolTipService.ToolTip="Repeat" Width="48" Height="48" Margin="8" Background="Transparent" Click="Control_Click">
                    <SymbolIcon Symbol="RepeatAll" Foreground="{ThemeResource SecondaryForegroundBrush}"/>
                </Button>
            </StackPanel>

            <!-- Vol -->
            <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="24">

                <Button x:Name="MoreButton" ToolTipService.ToolTip="More" Width="48" Height="48" Margin="8" Background="Transparent" BorderThickness="0">
                    <Button.Flyout>
                        <MenuFlyout>
                            <MenuFlyoutItem Text="Go to album" Click="GoToAlbum_Click">
                                <MenuFlyoutItem.Icon>
                                    <FontIcon Glyph="&#xE93C;" FontFamily="Segoe MDL2 Assets"/>
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>
                            <MenuFlyoutItem Text="Current Queue" Click="Queue_Click">
                                <MenuFlyoutItem.Icon>
                                    <SymbolIcon Symbol="List"/>
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>
                            <MenuFlyoutItem Text="Add to playlist" Click="AddToPlaylist_Click_Player">
                                <MenuFlyoutItem.Icon>
                                    <SymbolIcon Symbol="Add"/>
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>
                            <MenuFlyoutItem Text="Download" Click="Download_Click_Player">
                                <MenuFlyoutItem.Icon>
                                    <SymbolIcon Symbol="Download"/>
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>
                        </MenuFlyout>
                    </Button.Flyout>
                    <SymbolIcon Symbol="More" Foreground="{ThemeResource ForegroundBrush}"/>
                </Button>
                <StackPanel x:Name="VolumePanel" Orientation="Horizontal">
                    <TextBlock x:Name="VolumeIcon" Text="&#xE767;" FontFamily="Segoe MDL2 Assets" FontSize="20" VerticalAlignment="Center" Tapped="VolumeIcon_Tapped"/>
                    <TextBlock Text="{Binding VolumeDisplay}" FontSize="14" VerticalAlignment="Center" Margin="8,0,0,0" Width="30" TextAlignment="Center"/>
                    <Slider x:Name="VolumeSlider" Width="100" Margin="12,0" VerticalAlignment="Center" Value="{Binding Volume, Mode=TwoWay}" Maximum="1" StepFrequency="0.05" IsThumbToolTipEnabled="True" ThumbToolTipValueConverter="{StaticResource VolumeTooltipConverter}"/>
                </StackPanel>
            </StackPanel>
        </Grid>

        <!-- MediaElement Removed: Replaced by Background MediaPlayer in PlaybackService -->
        <!-- <MediaElement x:Name="GlobalMediaElement" x:FieldModifier="Public" AudioCategory="Media" AutoPlay="False" IsLooping="False" AreTransportControlsEnabled="False" Width="1" Height="1" Opacity="0.001" /> -->
    </Grid>
</Page>
